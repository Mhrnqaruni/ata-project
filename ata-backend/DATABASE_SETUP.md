# ðŸ—„ï¸ Database Setup Guide

## Quick Start

### Windows (CMD)
```cmd
cd ata-backend
reset_and_migrate.bat
```

### Windows (PowerShell)
```powershell
cd ata-backend
.\reset_and_migrate.ps1
```

---

## What These Scripts Do

The automated scripts perform the following steps:

1. âœ… **Drop Database** - Removes existing `ata_local_db` database
2. âœ… **Create Database** - Creates fresh `ata_local_db` database
3. âœ… **Delete Old Migrations** - Removes all `.py` files from `alembic/versions/`
4. âœ… **Activate venv** - Activates Python virtual environment
5. âœ… **Generate Migration** - Runs `alembic revision --autogenerate`
6. âœ… **Fix Table Order** - Automatically reorders table creation to prevent FK errors
7. âœ… **Apply Migrations** - Runs `alembic upgrade head`
8. âœ… **Verify Setup** - Lists all created database tables

---

## Manual Setup (If Scripts Don't Work)

If you need to run the steps manually:

```cmd
REM 1. Drop and create database
psql "postgresql://ata_user:ata_password@localhost:5432/postgres" -c "DROP DATABASE IF EXISTS ata_local_db;"
psql "postgresql://ata_user:ata_password@localhost:5432/postgres" -c "CREATE DATABASE ata_local_db;"

REM 2. Clean migrations
cd ata-backend
del alembic\versions\*.py
echo. > alembic\versions\__init__.py

REM 3. Activate venv
venv\Scripts\activate

REM 4. Generate migration
alembic revision --autogenerate -m "Initial database schema"

REM 5. Fix table ordering
python fix_autogenerated_migration.py

REM 6. Apply migrations
alembic upgrade head

REM 7. Verify
psql "postgresql://ata_user:ata_password@localhost:5432/ata_local_db" -c "\dt"
```

---

## Why the Fix Script is Needed

When you run `alembic revision --autogenerate`, Alembic inspects your SQLAlchemy models and generates a migration. However, it doesn't always create tables in the correct order.

**The Problem:**
- `quiz_participants` table needs a foreign key to `quiz_session_roster`
- But Alembic might create `quiz_participants` BEFORE `quiz_session_roster`
- This causes: `relation "quiz_session_roster" does not exist`

**The Solution:**
The `fix_autogenerated_migration.py` script:
- Detects the newly generated migration
- Finds table creation blocks
- Reorders them so `quiz_session_roster` comes before `quiz_participants`
- Preserves all foreign keys and indexes

---

## Troubleshooting

### Error: "psql: command not found"
**Solution:** Add PostgreSQL to your PATH or use full path:
```cmd
"C:\Program Files\PostgreSQL\15\bin\psql.exe" ...
```

### Error: "alembic: command not found"
**Solution:** Activate venv first:
```cmd
cd ata-backend
venv\Scripts\activate
pip install alembic
```

### Error: "role 'ata_user' does not exist"
**Solution:** Create the database user:
```sql
-- As postgres superuser
CREATE USER ata_user WITH PASSWORD 'ata_password';
ALTER USER ata_user WITH CREATEDB;
```

### Error: "No module named 'app'"
**Solution:** Make sure you're in the `ata-backend` directory and venv is activated.

### Error: Table creation fails even after fix
**Solution:** Check the generated migration manually:
```cmd
dir alembic\versions\
notepad alembic\versions\<newest_file>.py
```

Look for the order of `op.create_table()` calls. `quiz_session_roster` must come before `quiz_participants`.

---

## Database Connection Settings

The scripts use these default credentials:
- **Host:** localhost
- **Port:** 5432
- **User:** ata_user
- **Password:** ata_password
- **Database:** ata_local_db

To change these, edit:
1. The scripts (`reset_and_migrate.bat` / `.ps1`)
2. Your `.env` file
3. `alembic/env.py` (for migrations)

---

## Files Created

After running the setup, you'll have:

### Database Tables:
- `users` - User authentication
- `students` - Student records
- `classes` - Class management
- `quizzes` - Quiz definitions
- `quiz_sessions` - Live quiz sessions
- `quiz_session_roster` - Expected students per session âœ¨ NEW
- `quiz_participants` - Students who joined
- `quiz_outsider_students` - Unexpected participants âœ¨ NEW
- `quiz_questions` - Quiz questions
- `quiz_responses` - Student answers
- `assessments` - Assessment jobs
- `chatsessions` - Chat history
- And more...

### Migration Files:
- `alembic/versions/<timestamp>_initial_database_schema.py`

---

## Development Workflow

When you make model changes:

```cmd
REM Option 1: Full reset (development only!)
reset_and_migrate.bat

REM Option 2: Create new migration (for incremental changes)
alembic revision --autogenerate -m "Add new field"
python fix_autogenerated_migration.py  # If needed
alembic upgrade head
```

---

## Production Deployment

**âš ï¸ WARNING:** These scripts DROP the database. For production:

1. **Backup first:**
   ```cmd
   pg_dump ata_production_db > backup.sql
   ```

2. **Use incremental migrations:**
   ```cmd
   alembic upgrade head
   ```

3. **Never delete migrations in production!**

---

## Need Help?

- Check `MIGRATION_FIX_GUIDE.md` for detailed troubleshooting
- Check `QUICK_FIX_MIGRATIONS.md` for common issues
- Review `fix_autogenerated_migration.py` to understand table reordering

---

## Summary

âœ… **Use `reset_and_migrate.bat` for automated setup**
âœ… **All table ordering issues are automatically fixed**
âœ… **Works with your existing workflow**
âœ… **No manual editing required**

Your command sequence now becomes:
```cmd
cd ata-backend
reset_and_migrate.bat
```

That's it! ðŸŽ‰
